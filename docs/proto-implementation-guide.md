# Proto 實施指南

本文檔提供了如何遵循新的 Proto 架構進行開發的詳細指導。

## 整體結構

```
/proto
  /api                     # API 定義
    /v1                    # API 版本 1
      /lottery             # 彩票服務
        - service.proto    # 服務定義
        - game.proto       # 遊戲相關消息
        - ball.proto       # 球相關消息
        - events.proto     # 事件相關消息
  /common                  # 共享定義
    - common.proto         # 共享類型
    - error.proto          # 錯誤定義
  /third_party             # 第三方依賴
    /validate
      - validate.proto     # 驗證規則
  /buf.yaml                # Buf 配置
  /buf.gen.yaml            # 代碼生成配置
```

## 組織原則

1. **按服務分層** - 每個服務都有自己的目錄
2. **按版本管理** - 不同版本的 API 放在不同的目錄
3. **共享定義集中** - 所有共享類型都在 common 目錄
4. **明確的依賴** - 清晰表明每個文件的依賴關係
5. **一致的命名** - 遵循統一的命名規範

## 命名規範

### 文件命名

- 使用小寫和下劃線
- 基於功能而非數據結構命名
- 盡量簡短但有描述性

### 包命名

- 使用點號分隔的層次結構 (例如: `api.v1.lottery`)
- 版本包含在包名中
- 避免使用下劃線

### 消息和服務命名

- **消息**：使用 PascalCase (例如: `GameData`)
- **服務**：使用 PascalCase，並以 Service 結尾 (例如: `LotteryService`)
- **方法**：使用 PascalCase (例如: `StartNewRound`)
- **枚舉**：使用 PascalCase (例如: `GameStage`)
- **枚舉值**：使用全大寫和下劃線 (例如: `GAME_STAGE_PREPARATION`)

## 註釋規範

每個元素都應該有詳細的註釋：

- **文件頂部**：說明文件的整體用途
- **服務**：說明服務的整體功能
- **方法**：說明方法的功能、輸入參數和返回值的含義
- **消息**：說明消息的用途和使用場景
- **字段**：說明字段的含義和約束

## 類型設計

### 通用類型

放在 `common` 目錄：
- 共享的枚舉類型
- 錯誤定義
- 分頁參數
- 基礎數據類型

### 服務特定類型

放在各服務目錄：
- 請求/回應消息
- 服務特有的實體
- 只在該服務中使用的枚舉和常量

## 版本控制

### 何時創建新版本

- 任何破壞性變更都必須創建新版本
- 主要功能變更應考慮新版本
- 接口重新設計應使用新版本

### 兼容性維護

- 新增字段時使用新的字段編號
- 標記棄用字段而非直接刪除
- 使用 `reserved` 關鍵字保留已刪除的字段編號
- 新方法應使用新的方法名稱

## 使用 Buf 工具

### 安裝

```bash
go install github.com/bufbuild/buf/cmd/buf@latest
```

### 常用命令

- 格式化：`buf format -w`
- 語法檢查：`buf lint`
- 破壞性變更檢查：`buf breaking --against '.git#branch=main'`
- 生成代碼：`buf generate`

## 實施最佳實踐

1. **職責單一**：每個服務應有明確的職責
2. **API 隱藏實現細節**：客戶端不應依賴實現細節
3. **字段驗證**：使用 `validate` 規則進行字段驗證
4. **明確的錯誤處理**：返回明確的錯誤碼和描述
5. **分頁支持**：列表接口應支持分頁
6. **保持向後兼容**：避免破壞客戶端
7. **精簡消息定義**：避免過度設計 