version: '3.8'

services:
  # 樂透服務
  lottery-service:
    build:
      context: ../..  # 指向項目的根目錄
      dockerfile: deploy/lottery_service/Dockerfile
    image: lottery-service:latest
    container_name: lottery-service
    restart: unless-stopped
    environment:
      - NACOS_ADDR=http://nacos:8848
      # 保留舊版環境變數以確保向後相容
      - NACOS_HOST=nacos
      - NACOS_PORT=8848
      - NACOS_NAMESPACE=public
      - NACOS_GROUP=DEFAULT_GROUP
      - NACOS_USERNAME=nacos
      - NACOS_PASSWORD=nacos
      - NACOS_DATAID=lottery-service
      - ENABLE_NACOS=true
      # 設置日誌級別為 info 以減少生產環境日誌量
      - LOG_LEVEL=info
      - LOG_DIR=/app/logs
      - SERVER_MODE=prod
    ports:
      - "9100:9100"  # gRPC 服務端口 (從 50051 修改為 9100)
      - "8080:8080"    # WebSocket 端口
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    volumes:
      - lottery-logs:/app/logs
    depends_on:
      nacos:
        condition: service_healthy
      redis:
        condition: service_healthy
      tidb:
        condition: service_healthy
      rocketmq-namesrv:
        condition: service_started
      rocketmq-broker:
        condition: service_started
    networks:
      - lottery-network

  # Nacos 服務註冊與配置中心
  nacos:
    image: nacos/nacos-server:latest
    container_name: nacos
    restart: unless-stopped
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
      - NACOS_AUTH_ENABLE=true
      - NACOS_AUTH_TOKEN_EXPIRE_SECONDS=18000
      - NACOS_AUTH_TOKEN=SecretKey012345678901234567890123456789012345678901234567890123456789
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=tidb
      - MYSQL_SERVICE_PORT=4000
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=
      - MYSQL_SERVICE_DB_NAME=nacos
    volumes:
      - nacos-data:/home/nacos/data
      - nacos-logs:/home/nacos/logs
    ports:
      - "8848:8848"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8848/nacos/"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    depends_on:
      tidb:
        condition: service_healthy
    networks:
      - lottery-network

  # TiDB 數據庫
  tidb:
    image: pingcap/tidb:latest
    container_name: tidb
    restart: unless-stopped
    ports:
      - "4000:4000"
      - "10080:10080"
    volumes:
      - tidb-data:/tmp/tidb
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-P", "4000"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
    networks:
      - lottery-network

  # Redis 服務
  redis:
    image: redis:latest
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass redis123
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis123", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - lottery-network

  # RocketMQ NameServer
  rocketmq-namesrv:
    image: apache/rocketmq:latest
    container_name: rocketmq-namesrv
    restart: unless-stopped
    ports:
      - "9876:9876"
    volumes:
      - rocketmq-namesrv-logs:/home/rocketmq/logs
    command: sh mqnamesrv
    networks:
      - lottery-network

  # RocketMQ Broker
  rocketmq-broker:
    image: apache/rocketmq:latest
    container_name: rocketmq-broker
    restart: unless-stopped
    ports:
      - "10909:10909"
      - "10911:10911"
    volumes:
      - rocketmq-broker-logs:/home/rocketmq/logs
      - rocketmq-broker-store:/home/rocketmq/store
      - ./rocketmq/broker.conf:/home/rocketmq/conf/broker.conf
    command: sh mqbroker -c /home/rocketmq/conf/broker.conf
    depends_on:
      - rocketmq-namesrv
    environment:
      - NAMESRV_ADDR=rocketmq-namesrv:9876
    networks:
      - lottery-network

  # RocketMQ Dashboard
  rocketmq-dashboard:
    image: apacherocketmq/rocketmq-dashboard:latest
    container_name: rocketmq-dashboard
    restart: unless-stopped
    ports:
      - "8180:8080"
    environment:
      - JAVA_OPTS=-Drocketmq.namesrv.addr=rocketmq-namesrv:9876
    depends_on:
      - rocketmq-namesrv
      - rocketmq-broker
    networks:
      - lottery-network

volumes:
  nacos-data:
  nacos-logs:
  tidb-data:
  redis-data:
  rocketmq-namesrv-logs:
  rocketmq-broker-logs:
  rocketmq-broker-store:
  lottery-logs:

networks:
  lottery-network:
    driver: bridge 